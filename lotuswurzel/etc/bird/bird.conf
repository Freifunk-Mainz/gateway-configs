define wi_addr_ic = 10.207.0.56;  # lotuswurzel = wiesbaden1
define wi_addr_wi = 10.56.0.23;
define mz_addr_mz = 10.37.0.23;
router id 10.207.0.56;

table ic; # BGP Peerings 4 wi (ICVPN) and local wimz nets
table ic_mz; # BGP Peerings 4 mz (ICVPN) - copy of ic
table ic_gen;

function is_freifunk_dn42() {
    return (net ~ [
        10.0.0.0/8{12,32},
        172.22.0.0/15+,
        172.31.0.0/16
        ]);
}

function is_wimz_self_nets() {
    return (net ~ [10.56.0.0/16+,
                   10.37.0.0/16+]);
}

function is_wi_self_net() {
    return (net ~ [10.56.0.0/16+]);
}

function is_mz_self_net() {
    return (net ~ [10.37.0.0/16+]);
}

# necessary to inform bird about devices
protocol device {
    scan time 30;
};
# learn about directly connected community subnets
protocol direct wi_subnets {
    interface 10.37.0.0/16;
    interface 10.56.0.0/16;
    table ic;
};

protocol kernel kernel_wi {
    scan time 30;
    import none;
    export filter {
        if is_wimz_self_nets() then
            reject;
        krt_prefsrc = wi_addr_wi;
        accept;
    };
    table ic;
    kernel table 56;
};

protocol pipe wi2mz {
    import all;
    export none;
    table ic_mz;
    peer table ic;
};
 
protocol kernel kernel_mz {
    scan time 30;
    import none;
    export filter {
        if is_wimz_self_nets() then
            reject;
        krt_prefsrc = mz_addr_mz;
        accept;
    };
    table ic_mz;
    kernel table 37;
};

protocol pipe wi2gen {
    import all;
    export none;
    table ic_gen;
    peer table ic;
};

protocol kernel kernel_gen {
    scan time 30;
    import none;
    export filter {
        if is_wimz_self_nets() then
            reject;
        krt_prefsrc = wi_addr_ic;
        accept;
    };
    table ic_gen;
    kernel table 42;
};

# templates for iBGP
template bgp bgp_ibgp_wi {
    local wi_addr_wi as 65036;
    table ic;
    import all;  # EXPERIMENT !!!!!
    export where source = RTS_BGP;
    direct;
    gateway direct;
};

# templates for eBGP
template bgp ebgp_ic {
    local wi_addr_ic as 65036;
    table ic;
    import where (is_freifunk_dn42() && !is_wimz_self_nets());
    export filter {
        if is_wi_self_net() then {  # own nets
#            bgp_path.delete(65036);
#            bgp_path.prepend(65036);
            bgp_path.prepend(65036);
            accept;
        }
        if is_mz_self_net() then {  # foreign mz nets
            bgp_path.delete(65036);
            bgp_path.prepend(65037);
            bgp_path.prepend(65036);
            accept;
        }
        if source = RTS_BGP then {
            accept;
        }
        reject;
    };
    direct;
};

# P E E R I N G S
# iBGP 

#protocol bgp wiesbaden2 from bgp_ibgp_wi { # hinterschinken ???
#    neighbor 10.56.0.5 as 65036;
#};

# P E E R I N G S
# eBGP (siehe IPv6)

protocol bgp Augsburg1 from ebgp_ic {
    neighbor 10.207.0.17 as 65050;
};

protocol bgp Augsburg2 from ebgp_ic {
    neighbor 10.207.0.68 as 65050;
};

protocol bgp BadZwischenahn1 from ebgp_ic {
    neighbor 10.207.0.26 as 65025;
};

protocol bgp basel1 from ebgp_ic {
    neighbor 10.207.5.1 as 65090;
};

#protocol bgp Bayreuth1 from ebgp_ic {
#    neighbor 10.207.0.28 as 65025;
#};

protocol bgp Berlin1 from ebgp_ic {
    neighbor 10.207.0.5 as 44194;
};

protocol bgp Bielefeld1 from ebgp_ic {
    neighbor 10.207.0.59 as 65529;
};

protocol bgp Bielefeld2 from ebgp_ic {
    neighbor 10.207.0.67 as 65529;
};

protocol bgp braunschweig1 from ebgp_ic {
    neighbor 10.207.0.40 as 65380;
};

protocol bgp braunschweig2 from ebgp_ic {
    neighbor 10.207.0.41 as 65380;
};

debug commands 2;

protocol bgp Bremen2 from ebgp_ic {
    neighbor 10.207.0.196 as 65196;
    debug { states,interfaces,events };
};

protocol bgp Chemnitz1 from ebgp_ic {
    neighbor 10.207.0.36 as 65053;
};

protocol bgp darmstadt1 from ebgp_ic {
    neighbor 10.207.0.218 as 65038;
};

protocol bgp darmstadt2 from ebgp_ic {
    neighbor 10.207.0.219 as 65038;
};

protocol bgp dreilaendereck1 from ebgp_ic {
    neighbor 10.207.0.75 as 65043;
};

protocol bgp Dresden1 from ebgp_ic {
    neighbor 10.207.0.19 as 65051;
};

protocol bgp Dresden2 from ebgp_ic {
    neighbor 10.207.0.20 as 65051;
};

protocol bgp flensburg1 from ebgp_ic {
    neighbor 10.207.0.129 as 65056;
};

protocol bgp flensburg2 from ebgp_ic {
    neighbor 10.207.0.128 as 65056;
};

protocol bgp Franken1 from ebgp_ic {
    neighbor 10.207.0.23 as 65024;
};

protocol bgp Franken2 from ebgp_ic {
    neighbor 10.207.0.24 as 65024;
};

protocol bgp Franken3 from ebgp_ic {
    neighbor 10.207.0.31 as 65024;
};

protocol bgp Frankfurt1 from ebgp_ic {
    neighbor 10.207.0.35 as 65026;
};

protocol bgp Freiburg1 from ebgp_ic {
    neighbor 10.207.0.21 as 65060;
};

protocol bgp graz1 from ebgp_ic {
    neighbor 10.207.1.2 as 65048;
};

protocol bgp graz2 from ebgp_ic {
    neighbor 10.207.1.3 as 65048;
};

protocol bgp Gronau1 from ebgp_ic {
    neighbor 10.207.0.55 as 65526;
};

protocol bgp Gronau2 from ebgp_ic {
    neighbor 10.207.0.60 as 65526;
};

#protocol bgp Grossdraxdorf from ebgp_ic {
#    neighbor 10.207.0.25 as 65025;
#};

protocol bgp guetersloh1 from ebgp_ic {
    neighbor 10.207.0.132 as 65533;
};

protocol bgp guetersloh2 from ebgp_ic {
    neighbor 10.207.0.133 as 65533;
};

protocol bgp guetersloh3 from ebgp_ic {
    neighbor 10.207.0.134 as 65533;
};

protocol bgp Halle1 from ebgp_ic {
    neighbor 10.207.0.13 as 65046;
};

protocol bgp Halle2 from ebgp_ic {
    neighbor 10.207.0.14 as 65046;
};

protocol bgp hamburg01 from ebgp_ic {
    neighbor 10.207.0.62 as 65112;
};

protocol bgp hamburg05 from ebgp_ic {
    neighbor 10.207.0.65 as 65112;
};

protocol bgp Hannover1 from ebgp_ic {
    neighbor 10.207.0.22 as 65511;
};

protocol bgp Jena1 from ebgp_ic {
    neighbor 10.207.0.33 as 65055;
};

protocol bgp Jena2 from ebgp_ic {
    neighbor 10.207.0.66 as 65055;
};

protocol bgp kbu from ebgp_ic {
    neighbor 10.207.0.57 as 65528;
};

protocol bgp Koblenz from ebgp_ic {
    neighbor 10.207.0.32 as 65032;
};

protocol bgp Leipzig1 from ebgp_ic {
    neighbor 10.207.0.1 as 65041;
};

protocol bgp Leipzig2 from ebgp_ic {
    neighbor 10.207.0.2 as 65041;
};

protocol bgp Ljubljana1 from ebgp_ic {
    neighbor 10.207.3.23 as 65023;
};

protocol bgp Ljubljana2 from ebgp_ic {
    neighbor 10.207.3.30 as 65023;
};

protocol bgp Luebeck1 from ebgp_ic {
    neighbor 10.207.0.130 as 65052;
};

protocol bgp Luebeck2 from ebgp_ic {
    neighbor 10.207.0.131 as 65052;
};

protocol bgp luenen from ebgp_ic {
    neighbor 10.207.0.34 as 65034;
};

protocol bgp magdeburg1 from ebgp_ic {
    neighbor 10.207.39.1 as 65039;
};

protocol bgp magdeburg2 from ebgp_ic {
    neighbor 10.207.39.2 as 65039;
};

protocol bgp moehne1 from ebgp_ic {
    neighbor 10.207.0.120 as 65057;
};

protocol bgp muenchen1 from ebgp_ic {
    neighbor 10.207.0.80 as 65080;
};

protocol bgp Oldenburg1 from ebgp_ic {
    neighbor 10.207.0.27 as 65513;
    debug { states,interfaces,events };
};

protocol bgp Oldenburg2 from ebgp_ic {
    neighbor 10.207.0.38 as 65513;
};

protocol bgp ostholstein1 from ebgp_ic {
    neighbor 10.207.0.135 as 65152;
};

protocol bgp rheinland0 from ebgp_ic {
    neighbor 10.207.0.76 as 65078;
};

protocol bgp rheinland1 from ebgp_ic {
    neighbor 10.207.0.77 as 65078;
};

protocol bgp rheinland2 from ebgp_ic {
    neighbor 10.207.0.78 as 65078;
};

protocol bgp RheinNeckar from ebgp_ic {
    neighbor 10.207.0.142 as 76118;
};

protocol bgp ruhrgebiet1 from ebgp_ic {
    neighbor 10.207.0.79 as 65079;
};

#protocol bgp stuttgart from ebgp_ic {
#    neighbor 10.207.0.11 as 65045;
#};

protocol bgp Treuenbrietzen from ebgp_ic {
    neighbor 10.207.0.18 as 65045;
};

protocol bgp Weimar1 from ebgp_ic {
    neighbor 10.207.0.3 as 65042;
};

protocol bgp Weimar2 from ebgp_ic {
    neighbor 10.207.0.4 as 65042;
};

protocol bgp Wermelskirchen1 from ebgp_ic {
    neighbor 10.207.0.7 as 65530;
};

protocol bgp Wermelskirchen2 from ebgp_ic {
    neighbor 10.207.0.8 as 65530;
};

protocol bgp weststeiermark1 from ebgp_ic {
    neighbor 10.207.0.51 as 65054;
};

protocol bgp wuppertal1 from ebgp_ic {
    neighbor 10.207.0.73 as 65523;
};
